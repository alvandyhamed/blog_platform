# =========================
#  upstream Ù‡Ø§
# =========================
upstream identity_service {
    # Ø­ÙˆØ§Ø³Øª Ø¨Ø§Ø´Ù‡ Ù¾ÙˆØ±Øª Ø¨Ø§ Ú†ÛŒØ²ÛŒ Ú©Ù‡ ÙˆØ§Ù‚Ø¹Ø§Ù‹ run Ø´Ø¯Ù‡ ÛŒÚ©ÛŒ Ø¨Ø§Ø´Ù‡
    # ØªÙˆ Ú¯ÙØªÛŒ Identity Ø±ÙˆÛŒ 5090 Ù‡Ø³Øª:
    server 127.0.0.1:5090;
}

upstream article_service {
    server 127.0.0.1:5237;
}

# =========================
#  server Ø¨Ø±Ø§ÛŒ api.blog.local
# =========================
server {
    listen 8095;
    server_name api.blog.local;

    access_log /opt/homebrew/var/log/nginx/blog-api-access.log;
    error_log  /opt/homebrew/var/log/nginx/blog-api-error.log;

    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # -------------------------
    #  Identity (api/auth/*)
    # -------------------------
    location /api/auth/ {
        proxy_pass http://identity_service;
    }

    # Swagger Identity  ğŸ‘‰ Ø§ÛŒÙ†â€ŒØ¬Ø§ Ø±Ùˆ ÙÛŒÚ©Ø³ Ú©Ø±Ø¯ÛŒÙ…
    location /identity/swagger/ {
        # Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…: Ù†Ø°Ø§Ø± upstream gzip Ú©Ù†Ù‡ ØªØ§
        # ERR_CONTENT_LENGTH_MISMATCH Ø­Ù„ Ø¨Ø´Ù‡
        proxy_set_header Accept-Encoding "";

        proxy_pass http://identity_service/swagger/;

        # Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¨ÛŒØ´ØªØ±:
        proxy_buffering off;
    }

    # -------------------------
    #  Articles (api/articles/*)
    # -------------------------
    location /api/articles/ {
        proxy_pass http://article_service;
    }

    # Swagger Articles (Ø§ÛŒÙ†â€ŒÚ©Ù‡ Ø§Ù„Ø§Ù† Ø¯Ø±Ø³Øª Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡)
    location /articles/swagger/ {
        proxy_set_header Accept-Encoding "";
        proxy_pass http://article_service/swagger/;
        proxy_buffering off;
    }

    # health check Ø³Ø§Ø¯Ù‡
    location /health {
        return 200 "OK\n";
    }
}